# ESTIMATION.md

## Краткое резюме

Задача — добавить систему имён пользователей в существующее Flutter-приложение с бэкендом на Supabase. Затрагивает 8+ файлов: новый сервис, новый экран, рефакторинг двух существующих экранов, изменение роутинга и обновление двух сервисов. Ключевые сложности — реалтаймовый поиск с debounce и race-condition guard, офлайн-деградация с чёткой логикой приоритетов, а также предварительная миграция схемы БД как внешний блокер.

---

## Оценка сложности

- **Уровень:** Средняя (ближе к верхней границе)
- **Общая оценка:** 8–11 рабочих дней (включая буфер 25%)
- **Количество разработчиков:** 1 (задача линейно зависима, параллелить нечего без рисков конфликтов)

**Обоснование:**
- 4 независимых компонента (UserService, GuardiansService, WelcomeScreen, routing) можно делать последовательно по ½–1 дню каждый
- GuardiansScreen — самый сложный элемент: debounce + async + race condition + offline logic + отображение 4 вариантов имени
- Есть внешняя зависимость (Supabase migration + RLS), которую нельзя устранить кодом
- Локализация на 3 языка добавляет постоянный overhead к каждому UI-экрану

---

## Подзадачи

### 1. Supabase: миграция схемы и проверка RLS

- **Описание:** Добавить колонку `user_name TEXT NULL` в таблицу `users`. Проверить и при необходимости настроить политики RLS: anon-токен должен иметь право SELECT на поля `user_id` и `user_name`, UPDATE на собственную запись.
- **Трудозатраты:** 0.5 дня
- **Приоритет:** Critical
- **Зависит от:** нет (внешняя операция, блокирует всё остальное)
- **Критерии готовности:**
  - Колонка `user_name` существует в таблице `users` в Supabase Dashboard
  - `SELECT user_name FROM users WHERE user_id = 'TEST'` выполняется успешно с anon-ключом (возвращает null или значение)
  - `UPDATE users SET user_name = 'Test' WHERE user_id = 'TEST'` выполняется успешно с anon-ключом

---

### 2. UserService: расширение методами работы с именем

- **Описание:** Добавить в `lib/services/user_service.dart` три метода: `hasUserName()` → bool, `getUserName()` → String?, `saveUserName(String name)` → Future. Метод `saveUserName` сохраняет в SharedPreferences и выполняет `.update({'user_name': name}).eq('user_id', userId)` в Supabase. При сетевой ошибке — локальное сохранение не откатывается, выбрасывает исключение вызывающему коду для показа Snackbar.
- **Трудозатраты:** 0.5 дня
- **Приоритет:** Critical
- **Зависит от:** подзадача 1 (колонка должна существовать)
- **Критерии готовности:**
  - `hasUserName()` возвращает `false` если ключ `user_name` отсутствует или пуст, `true` иначе
  - `saveUserName('Alice')` → SharedPreferences содержит `user_name = 'Alice'` И запись в Supabase обновлена
  - `saveUserName('Alice')` при отключённой сети → SharedPreferences обновлён, выброшено исключение

---

### 3. WelcomeScreen: новый экран ввода имени

- **Описание:** Создать `lib/screens/welcome_screen.dart`. Экран содержит: заголовок, текстовое поле (maxLength=50, обрезка пробелов), кнопку "Continue" (disabled пока `trim().isEmpty`). По нажатию: вызов `UserService.saveUserName()`, при ошибке Supabase — показать Snackbar-предупреждение, не блокировать переход. Переход на MainScreen через `Navigator.pushReplacement` (без возможности вернуться). Все строки — через ARB-локализацию.
- **Трудозатраты:** 1 день
- **Приоритет:** Critical
- **Зависит от:** подзадача 2
- **Критерии готовности:**
  - AC-01, AC-02, AC-16 покрыты
  - Кнопка "Continue" неактивна при пустом / только-пробельном вводе
  - После сохранения навигация ведёт на MainScreen, свайп/кнопка "Назад" не возвращают на WelcomeScreen
  - Строки UI присутствуют во всех трёх ARB-файлах

---

### 4. Роутинг в main.dart

- **Описание:** После завершения инициализации сервисов (текущий блок `try/catch` в `main()`) вызвать `UserService.hasUserName()`. Передать результат в `MyApp` и использовать для выбора `home`: `WelcomeScreen` или `MainScreen`. `MyApp` уже имеет `_locale` как state — добавить `_initialScreen` аналогично.
- **Трудозатраты:** 0.5 дня
- **Приоритет:** Critical
- **Зависит от:** подзадача 2, подзадача 3
- **Критерии готовности:**
  - AC-01 (нет имени → WelcomeScreen) и AC-03 (имя есть → MainScreen) покрыты
  - Существующие пользователи без `user_name` (legacy, EC-11) корректно попадают на WelcomeScreen

---

### 5. GuardiansService: сервис поиска пользователей

- **Описание:** Создать `lib/services/guardians_service.dart` с методом `static Future<String?> findUserName(String userId)`. Выполняет Supabase-запрос `SELECT user_name FROM users WHERE user_id = userId`. Возвращает строку (если непустая) или `null` (если не найдено, user_name = NULL, сетевая ошибка или таймаут >5с). Все исключения перехватываются внутри метода.
- **Трудозатраты:** 0.5 дня
- **Приоритет:** High
- **Зависит от:** подзадача 1
- **Критерии готовности:**
  - `findUserName('ABCD1234')` возвращает строку для существующего пользователя с именем
  - `findUserName('ZZZZZZZZ')` возвращает `null`
  - `findUserName(...)` при отключённой сети возвращает `null` без краша

---

### 6. GuardiansScreen: рефакторинг EmergencyNumberScreen

- **Описание:** Доработать `EmergencyNumberScreen` в `lib/screens/settings_screen.dart`. Изменения:
  1. **Debounce-поиск:** при изменении поля ID запускать `Timer(500ms, () => _search(id))`. При новом вводе — отменять предыдущий Timer (`_debounceTimer?.cancel()`). При очистке поля — сбрасывать статус.
  2. **Race condition guard:** хранить `_searchGeneration` (int, инкрементировать при каждом запуске), сравнивать при получении результата — игнорировать устаревшие ответы.
  3. **Статус поиска:** три состояния под полем ID — пусто, loading (CircularProgressIndicator), результат (`✓ Found: Name` / `⚠️ User not found`).
  4. **Поле Nickname:** опциональное TextField рядом с полем ID каждого хранителя.
  5. **Сохранение:** добавить `guardian1_nickname`…`guardian5_nickname` в SharedPreferences.
  6. **Загрузка:** при `initState` загружать и nickname-ключи из SharedPreferences.
  7. **Локализация:** все новые строки — через ARB.
- **Трудозатраты:** 2.5 дня
- **Приоритет:** High
- **Зависит от:** подзадача 5
- **Критерии готовности:**
  - AC-07, AC-08, AC-09, AC-10, AC-17 покрыты
  - При быстром вводе (< 500 мс между нажатиями) запрос не уходит в сеть
  - При очистке поля — статус сбрасывается
  - Stale response от предыдущего запроса не перетирает актуальный результат
  - Nickname сохраняется и загружается корректно

---

### 7. Список хранителей: отображение имён

- **Описание:** Внутри `EmergencyNumberScreen` (или отдельный виджет-список, если рефакторинг позволяет) — при загрузке экрана: читать все 5 guardian ID из SharedPreferences, запускать `Future.wait([guardians_service.findUserName(id1), ...])`. Для каждого хранителя применять логику FR-15 (только если запрос успешен) или FR-16 (если ошибка → только User ID). Показывать имя (основная строка) + ID (мелкий шрифт). Порядок вывода — строго `guardian1`…`guardian5` (индексировать результаты `Future.wait` по позиции, не по порядку завершения).
- **Трудозатраты:** 1 день
- **Приоритет:** High
- **Зависит от:** подзадача 5, подзадача 6
- **Критерии готовности:**
  - AC-11, AC-12, AC-13 покрыты
  - AC-13: при офлайне, даже если Nickname есть локально — показывается только User ID
  - EC-07: порядок хранителей в списке соответствует `guardian1`…`guardian5` вне зависимости от скорости ответов Supabase

---

### 8. MainScreen: отображение и редактирование имени

- **Описание:** В `lib/screens/main_screen.dart` — в карточке "My ID": загрузить имя через `UserService.getUserName()` в `initState`, отображать над строкой ID (если `!= null`). Добавить кнопку "Edit Name". По нажатию — `showDialog` с TextField (предзаполнен текущим именем, maxLength=50, кнопка Save disabled при `trim().isEmpty`, кнопка Cancel). По Save — `UserService.saveUserName()`, обновить локальный state `setState`.
- **Трудозатраты:** 1 день
- **Приоритет:** Medium
- **Зависит от:** подзадача 2
- **Критерии готовности:**
  - AC-04, AC-05, AC-06, AC-18 покрыты
  - Имя отображается над ID при наличии
  - Диалог закрывается без изменений при Cancel
  - Save disabled при пустом/пробельном вводе

---

### 9. SOSService: имя отправителя в уведомлении

- **Описание:** В `lib/services/sos_service.dart` в методе `sendSOS()` — получить имя через `UserService.getUserName()`. Сформировать строку `message`: с именем — `"SOS Emergency from [Name] ([ID])"`, без имени — `"SOS Emergency from [ID]"`. Передать в тело запроса к Edge Function (ключ `message` уже используется).
- **Трудозатраты:** 0.5 дня
- **Приоритет:** Medium
- **Зависит от:** подзадача 2
- **Критерии готовности:**
  - AC-14 и AC-15 покрыты
  - Формат строки точно соответствует SPEC (без лишних символов, без дублирования)

---

### 10. Локализация: новые строки ARB

- **Описание:** Добавить все новые UI-строки в `lib/l10n/app_en.arb` (шаблон), `app_ru.arb`, `app_zh.arb`. Запустить `flutter gen-l10n`. Охват: WelcomeScreen (заголовок, placeholder, кнопка), статусы поиска (Found, Not Found), GuardiansScreen (Nickname label/hint), MainScreen (Edit Name, диалог). Китайские строки допустимо поставить через machine translation с последующей проверкой носителем.
- **Трудозатраты:** 0.5 дня
- **Приоритет:** Medium
- **Зависит от:** подзадачи 3, 6, 7, 8 (знать все строки)
- **Критерии готовности:**
  - `flutter gen-l10n` выполняется без ошибок
  - Переключение языка в LanguageScreen меняет все новые строки корректно
  - Нет захардкоженных строк на русском/английском в новом UI-коде

---

### 11. Ручное тестирование по AC

- **Описание:** Пройти все 18 Acceptance Criteria из SPEC_VALIDATED.md. Дополнительно: EC-11 (legacy user без user_name), EC-04 (race condition — быстрый ввод), EC-12 (поиск legacy-пользователя), офлайн-сценарии. Тестировать на iOS (Simulator) и Android (Emulator).
- **Трудозатраты:** 1 день
- **Приоритет:** High
- **Зависит от:** все предыдущие подзадачи
- **Критерии готовности:**
  - Все 18 AC пройдены
  - Ни один из EC-01–EC-12 не вызывает краш или некорректное отображение

---

## Риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| RLS-политики Supabase не разрешают SELECT `user_name` для anon-токена — все поиски возвращают ошибку авторизации | Средняя | Высокое | Проверить и настроить RLS **до** начала разработки (подзадача 1). Тест: выполнить запрос с anon-ключом из Supabase Studio |
| Race condition в GuardiansScreen: стале-ответ от медленного Supabase-запроса перетирает актуальный результат | Высокая | Среднее | Реализовать generation counter (`_searchGeneration`); инкрементировать при каждом запросе; при получении ответа сравнивать поколения и игнорировать устаревшие |
| Legacy-пользователи видят WelcomeScreen при обновлении — возможны жалобы / негативный UX | Высокая | Среднее | Добавить поясняющий текст на WelcomeScreen ("Новая функция: добавьте имя, чтобы хранители знали, кто отправил SOS"). Задокументировать в release notes |
| Уведомление OneSignal не обновляется: заголовок `⚠️ SOS Emergency` (hardcoded в Edge Function) дублирует содержание поля `message` | Низкая | Низкое | Убедиться, что `message` передаётся в поле `contents`, а не `headings` Edge Function — это уже так (текущий код) |
| `saveUserName` вызывает UPDATE на запись пользователя, которой ещё нет в Supabase (если OneSignal init завершился с ошибкой в main.dart) | Низкая | Высокое | В `saveUserName` использовать `.upsert` с `onConflict: 'user_id'` вместо чистого `.update`, чтобы создать запись если отсутствует |
| Slow network: загрузка списка 5 хранителей через `Future.wait` → 5 параллельных запросов, каждый до 5 секунд → суммарный spinner до 5 секунд | Средняя | Среднее | Рассмотреть снижение таймаута до 3 секунд в NFR-02; или делать единый запрос `WHERE user_id IN (...)` для всех 5 ID сразу |

---

## Зависимости

### Внутренние (между подзадачами)

```
[1. DB Migration] ──────────────────────────────► [2. UserService]
                  └──────────────────────────────► [5. GuardiansService]

[2. UserService] ───────────────────────────────► [3. WelcomeScreen]
                 ├──────────────────────────────► [8. MainScreen]
                 └──────────────────────────────► [9. SOSService]

[3. WelcomeScreen] ─────────────────────────────► [4. Routing]

[5. GuardiansService] ──────────────────────────► [6. GuardiansScreen]
                      └─────────────────────────► [7. Список хранителей]

[6. GuardiansScreen] ───────────────────────────► [7. Список хранителей]

[3,6,7,8] ──────────────────────────────────────► [10. Локализация]

[все 1–10] ─────────────────────────────────────► [11. Тестирование]
```

**Оптимальный порядок выполнения:** 1 → 2 → (3 + 5 параллельно) → 4 → 6 → 7 → (8 + 9 параллельно) → 10 → 11

### Внешние

- **Supabase DB:** добавление колонки и настройка RLS — должны быть выполнены командой/разработчиком до начала кодинга (подзадача 1 — самостоятельная операция в Supabase Dashboard)
- **Локализация ZH:** китайские переводы требуют проверки носителем; machine translation приемлемо для MVP

---

## Рекомендации Tech Lead

**1. Начать с миграции БД в первый час.** Это единственный внешний блокер. Пока она не выполнена, нельзя тестировать ни UserService, ни GuardiansService. Выполнить в Supabase Dashboard: `ALTER TABLE users ADD COLUMN user_name TEXT;` + проверить RLS.

**2. Оптимизировать запрос для списка хранителей.** Вместо 5 параллельных запросов `findUserName` использовать один батчевый запрос:
```sql
SELECT user_id, user_name FROM users WHERE user_id IN (id1, id2, id3, id4, id5)
```
Это снизит нагрузку на Supabase и ускорит загрузку списка. Вынести в отдельный метод `GuardiansService.findUserNames(List<String> ids)`.

**3. `saveUserName` — использовать upsert, не update.** Если OneSignal-инициализация в `main.dart` упала с ошибкой, запись пользователя может отсутствовать в Supabase. Upsert страхует от этого кейса.

**4. Выделить debounce-логику в mixin или утилитный класс.** Паттерн debounce с Timer + generation counter повторяется в GuardiansScreen — если в будущем появятся другие экраны с поиском, это пригодится.

**5. Тестировать legacy-сценарий (EC-11) в первую очередь на реальном устройстве.** Именно этот кейс ударит по всем текущим пользователям при релизе. Убедиться, что WelcomeScreen не показывается повторно если пользователь уже установил имя.

**6. Порядок приоритетов для быстрого MVP:** подзадачи 1→2→4→3 дают работающий WelcomeScreen + роутинг (ключевой UX). Подзадачи 5→6→7 дают поиск и список. Подзадачи 8→9 — косметические улучшения, можно сдвинуть на следующую итерацию если давит дедлайн.

---

## Дата оценки

2026-02-23
